<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 Blackjack Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.1/ethers.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            touch-action: manipulation;
        }
        .game-table {
            background-color: #2c5282;
            border: 10px solid #1a365d;
            border-radius: 50px;
            width: 100%;
            height: 400px;
            position: relative;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
        }
        .card {
            background-color: white;
            color: black;
            border: 1px solid black;
            border-radius: 8px;
            width: 60px;
            height: 90px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0 5px;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div id="game-container" class="w-full max-w-5xl mx-auto flex flex-col lg:flex-row items-center lg:items-start gap-6">
        
        <!-- Game Table Area -->
        <div class="w-full lg:w-2/3">
            <div id="game-table" class="game-table shadow-2xl">
                <div>
                    <h2 class="text-xl font-bold">Dealer's Hand</h2>
                    <div id="dealer-hand" class="my-4"></div>
                </div>

                <!-- Score Board -->
                <div id="score-board" class="text-center">
                    <h3 class="text-lg font-semibold mb-2">คะแนน</h3>
                    <div class="grid grid-cols-2 gap-4 text-lg">
                        <div class="text-right font-bold">Dealer:</div>
                        <div id="dealer-score" class="text-left">0</div>
                        <div class="text-right font-bold">Player:</div>
                        <div id="player-score" class="text-left">0</div>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-bold">Player's Hand</h2>
                    <div id="player-hand" class="my-4"></div>
                </div>
            </div>
        </div>

        <div class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-xl flex flex-col gap-4">
            <h1 class="text-2xl font-bold text-gray-800 text-center">Web3 Blackjack</h1>
            
            <!-- Wallet Connection -->
            <div id="wallet-section">
                <button id="connect-button" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    เชื่อมต่อ Wallet
                </button>
                <div id="wallet-info" class="hidden mt-2 text-center bg-gray-100 p-2 rounded-lg">
                    <p class="text-sm font-semibold text-gray-700">เชื่อมต่อแล้ว:</p>
                    <p id="wallet-address" class="text-xs text-gray-500 break-all"></p>
                </div>
            </div>

            <!-- Game Actions -->
            <div class="flex flex-col items-center gap-2 py-4 border-t border-b">
                 <button id="join-game-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg" disabled>
                    เข้าร่วมเกม
                </button>
                <div class="w-full">
                    <input type="text" id="bet-amount" placeholder="ใส่จำนวนเงินเดิมพัน (ETH)" class="w-full border p-2 rounded">
                    <button id="place-bet-button" class="w-full mt-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg" disabled>
                        วางเดิมพัน
                    </button>
                </div>
                 <button id="start-game-button" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg mt-2" disabled>
                    เริ่มเกม
                </button>
                <div id="blackjack-actions" class="w-full grid grid-cols-2 gap-2 hidden">
                    <button id="action-hit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Hit</button>
                    <button id="action-stand" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Stand</button>
                </div>
            </div>

            <div>
                <h2 class="font-semibold text-gray-600 mb-2">เหตุการณ์ล่าสุด:</h2>
                <div id="message-log" class="h-24 bg-gray-100 rounded-md p-2 overflow-y-auto text-sm text-gray-700 border">
                    กรุณาเชื่อมต่อ Wallet เพื่อเริ่มเกม
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const playerHandDisplay = document.getElementById('player-hand');
        const dealerHandDisplay = document.getElementById('dealer-hand');
        const messageLog = document.getElementById('message-log');

        const connectButton = document.getElementById('connect-button');
        const walletInfo = document.getElementById('wallet-info');
        const walletAddressDisplay = document.getElementById('wallet-address');

        const joinGameButton = document.getElementById('join-game-button');
        const placeBetButton = document.getElementById('place-bet-button');
        const betAmountInput = document.getElementById('bet-amount');
        const startGameButton = document.getElementById('start-game-button');
        const blackjackActions = document.getElementById('blackjack-actions');
        const hitButton = document.getElementById('action-hit');
        const dealerScoreDisplay = document.getElementById('dealer-score');
        const playerScoreDisplay = document.getElementById('player-score');


        // --- Web3 State ---
        let provider, signer, userAddress, contract;
        const targetChainId = '0x7a69'; // 31337 in hex
        
        // !!! สำคัญ: กรอก Contract Address ของคุณที่นี่ !!!
        const contractAddress = "0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9"; // Placeholder
        
        const contractABI = [
            "event DealerHit(address indexed dealer, tuple(uint8 rank, uint8 suit) card)",
            "event GameFinished(address indexed winner)",
            "event PlayerBet(address indexed player, uint256 amount)",
            "event PlayerHit(address indexed player, tuple(uint8 rank, uint8 suit) card)",
            "event PlayerJoined(address indexed player)",
            "event PlayerStand(address indexed player)",
            "constructor()",
            "function currentCardIndex() view returns (uint256)",
            "function deck(uint256) view returns (uint8 rank, uint8 suit)",
            "function dealer() view returns (address)",
            "function dealerHand(uint256) view returns (uint8 rank, uint8 suit)",
            "function dealerHasBlackJack() view returns (bool)",
            "function dealerIsBusted() view returns (bool)",
            "function finishGame()",
            "function gameState() view returns (uint8)",
            "function getHandValue(tuple(uint8 rank, uint8 suit)[] memory hand) pure returns (uint8)",
            "function hit()",
            "function initializeDeck()",
            "function joinGame()",
            "function owner() view returns (address)",
            "function placeBet(uint256 amount) payable",
            "function playerAddresses(uint256) view returns (address)",
            "function players(address) view returns (address addr, uint256 bet, bool hasBlackJack, bool isBusted, bool hasStood)",
            "function playDealerTurn()",
            "function stand()",
            "function startGame()"
        ];

        // --- Game Logic ---
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                logMessage("กรุณาติดตั้ง MetaMask!");
                return;
            }

            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                const network = await provider.getNetwork();

                if (network.chainId.toString() !== parseInt(targetChainId, 16).toString()) {
                    logMessage(`กรุณาเปลี่ยนเป็นเครือข่าย ChainID: ${parseInt(targetChainId, 16)}`);
                    return;
                }

                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                contract = new ethers.Contract(contractAddress, contractABI, signer);

                walletAddressDisplay.textContent = userAddress;
                walletInfo.classList.remove('hidden');
                connectButton.textContent = "เชื่อมต่อสำเร็จ";
                connectButton.disabled = true;
                joinGameButton.disabled = false;

                logMessage(`เชื่อมต่อกับ Wallet: ${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`);
                listenToEvents();
            } catch (error) {
                console.error("Could not connect to wallet:", error);
                logMessage("การเชื่อมต่อ Wallet ล้มเหลว");
            }
        }

        function logMessage(msg) {
            const p = document.createElement('p');
            p.textContent = `> ${msg}`;
            messageLog.appendChild(p);
            messageLog.scrollTop = messageLog.scrollHeight;
        }

        function getHandValue(hand) {
            let value = 0;
            let numAces = 0;
            for (const card of hand) {
                const rank = Number(card.rank);
                if (rank >= 11 && rank <= 13) { // J, Q, K
                    value += 10;
                } else if (rank === 14) { // Ace
                    numAces++;
                    value += 11;
                } else {
                    value += rank;
                }
            }
            while (value > 21 && numAces > 0) {
                value -= 10;
                numAces--;
            }
            return value;
        }

        function createCard(card, isFaceDown = false) {
            const cardElement = document.createElement('div');
            cardElement.classList.add('card');
            if (isFaceDown) {
                 cardElement.style.backgroundColor = 'red'; // Back of card
                 cardElement.textContent = '';
            } else {
                let rank;
                switch(Number(card.rank)) {
                    case 11: rank = 'J'; break;
                    case 12: rank = 'Q'; break;
                    case 13: rank = 'K'; break;
                    case 14: rank = 'A'; break;
                    default: rank = card.rank.toString();
                }
                cardElement.textContent = rank;
            }
            return cardElement;
        }

        async function updateUI() {
            if (!contract || !userAddress) return;

            try {
                // Fetch all data in parallel
                const [playerData, rawDealerHand, gameState] = await Promise.all([
                    contract.players(userAddress),
                    contract.dealerHand(),
                    contract.gameState()
                ]);
                
                const playerHand = playerData.hand;

                // Update player's hand and score
                playerHandDisplay.innerHTML = '';
                playerHand.forEach(card => playerHandDisplay.appendChild(createCard(card)));
                const playerScore = getHandValue(playerHand);
                playerScoreDisplay.textContent = playerScore;

                if (playerScore > 21) {
                    logMessage("คุณแต้มเกิน 21 (Bust)!");
                    blackjackActions.classList.add('hidden');
                }

                // Update dealer's hand and score based on game state
                dealerHandDisplay.innerHTML = '';
                const GameState = { Betting: 0, PlayerTurn: 1, DealerTurn: 2, Finished: 3 };

                if (gameState == GameState.PlayerTurn && rawDealerHand.length > 0) {
                    // Player's turn: show one card face up, one face down
                    dealerHandDisplay.appendChild(createCard(rawDealerHand[0]));
                    dealerHandDisplay.appendChild(createCard(null, true)); // Face-down card
                    
                    // Show score of only the visible card
                    dealerScoreDisplay.textContent = `${getHandValue([rawDealerHand[0]])} + ?`;
                } else {
                    // Dealer's turn or game finished: show all cards and final score
                    rawDealerHand.forEach(card => dealerHandDisplay.appendChild(createCard(card)));
                    dealerScoreDisplay.textContent = getHandValue(rawDealerHand);
                }

            } catch (error) {
                console.error("Failed to update UI:", error);
                logMessage("เกิดข้อผิดพลาดในการอัปเดตข้อมูลเกม");
            }
        }

        async function handleJoinGame() {
            if(!contract) return;
            try {
                const tx = await contract.joinGame();
                logMessage("กำลังส่งคำขอเข้าร่วมเกม...");
                await tx.wait();
                logMessage("เข้าร่วมเกมสำเร็จ!");
                placeBetButton.disabled = false;
                startGameButton.disabled = false;
            } catch (error) {
                console.error(error);
                logMessage(error.reason || "การเข้าร่วมเกมล้มเหลว");
            }
        }

        async function handlePlaceBet() {
            if(!contract) return;
            const amount = betAmountInput.value;
            if (!amount || parseFloat(amount) <= 0) {
                logMessage("กรุณาใส่จำนวนเงินเดิมพันที่ถูกต้อง");
                return;
            }
            try {
                const value = ethers.parseEther(amount);
                const tx = await contract.placeBet(value, { value });
                logMessage("กำลังวางเดิมพัน...");
                await tx.wait();
                logMessage(`วางเดิมพันสำเร็จ: ${amount} ETH`);
            } catch (error) {
                console.error(error);
                logMessage(error.reason || "การวางเดิมพันล้มเหลว");
            }
        }

        async function handleStartGame() {
            if(!contract) return;
            try {
                const tx = await contract.startGame();
                logMessage("กำลังเริ่มเกม...");
                await tx.wait();
                logMessage("เกมเริ่มแล้ว! ขอให้โชคดี");
                blackjackActions.classList.remove('hidden');
                joinGameButton.disabled = true;
                placeBetButton.disabled = true;
                startGameButton.disabled = true;
                await updateUI();
            } catch (error) {
                console.error(error);
                logMessage(error.reason || "การเริ่มเกมล้มเหลว");
            }
        }

        async function handleHit() {
            if(!contract) return;
            try {
                const tx = await contract.hit();
                logMessage("คุณเลือก Hit, กำลังจั่วไพ่...");
                await tx.wait();
                logMessage("จั่วไพ่สำเร็จ!");
                await updateUI();
            } catch (error) {
                console.error(error);
                logMessage(error.reason || "การ Hit ล้มเหลว");
            }
        }

        async function handleStand() {
            if(!contract) return;
            try {
                const tx = await contract.stand();
                logMessage("คุณเลือก Stand, รอ Dealer เล่น...");
                blackjackActions.classList.add('hidden');
                await tx.wait();
                logMessage("Dealer เล่นจบแล้ว");
                // The contract events will trigger the final outcome message
                // We just update the UI to show the final hands and scores
                await updateUI();
            } catch (error) {
                console.error(error);
                logMessage(error.reason || "การ Stand ล้มเหลว");
            }
        }

        function listenToEvents() {
            if (!contract) return;
            contract.on("GameFinished", (winner, amount) => {
                 // UI update will be handled by the stand/bust logic, this is for the final message
                logMessage("เกมจบแล้ว!");
                updateUI(); // Final update to show all cards
                if (winner === userAddress) {
                    logMessage(`ยินดีด้วย! คุณชนะและได้รับ ${ethers.formatEther(amount)} ETH`);
                    alert("คุณชนะ!");
                } else {
                    logMessage("น่าเสียดาย, คุณแพ้ในรอบนี้");
                    alert("คุณแพ้!");
                }
                 // Reset buttons for next game
                joinGameButton.disabled = false;
                placeBetButton.disabled = false;
                startGameButton.disabled = false;
                betAmountInput.value = '';
            });

             contract.on("PlayerHit", (player, card) => {
                if (player === userAddress) {
                    const rank = Number(card.rank) > 10 ? card.rank === 14 ? 'A' : 'J/Q/K' : card.rank;
                    logMessage(`คุณได้รับไพ่: ${rank}`);
                }
            });

            contract.on("DealerHit", (dealer, card) => {
                const rank = Number(card.rank) > 10 ? card.rank === 14 ? 'A' : 'J/Q/K' : card.rank;
                logMessage(`Dealer จั่วได้ไพ่: ${rank}`);
            });
        }


        // --- Event Listeners ---
        connectButton.addEventListener('click', connectWallet);
        joinGameButton.addEventListener('click', handleJoinGame);
        placeBetButton.addEventListener('click', handlePlaceBet);
        startGameButton.addEventListener('click', handleStartGame);
        hitButton.addEventListener('click', handleHit);
        standButton.addEventListener('click', handleStand);

        window.addEventListener('DOMContentLoaded', () => {
            logMessage("กรุณาเชื่อมต่อ Wallet เพื่อเริ่มเกม");
        });
		
		 const contractABI = [
    // ... (keep all other ABI entries)
    "event GameFinished(address indexed winner, uint256 amount)", // Make sure amount is included
    // ...
];

function listenToEvents() {
    // ...
    contract.on("GameFinished", (winner, amount) => {
        logMessage("เกมจบแล้ว!");
        updateUI(); // Final update

        const winAmount = ethers.formatEther(amount);
        if (winner === userAddress) {
            if (amount > 0) {
                 logMessage(`ยินดีด้วย! คุณชนะและได้รับ ${winAmount} ETH`);
                 alert(`คุณชนะ! ได้รับ ${winAmount} ETH`);
            } else {
                 logMessage("เสมอ! คุณได้รับเงินเดิมพันคืน");
                 alert("เสมอ!");
            }
        } else {
            logMessage("น่าเสียดาย, คุณแพ้ในรอบนี้");
            alert("คุณแพ้!");
        }
        
        // Reset UI for the next round
        blackjackActions.classList.add('hidden');
        joinGameButton.disabled = false;
        placeBetButton.disabled = false;
        startGameButton.disabled = false;
        betAmountInput.value = '';
    });
    // ...
}

</body>
</html>